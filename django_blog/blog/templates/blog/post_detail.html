{% extends 'blog/base.html' %}
{% block content %}
  <article>
    <h2>{{ post.title }}</h2>
    <small>by {{ post.author.username }} • {{ post.published_date|date:'Y-m-d H:i' }}</small>
    <div>
      <p>{{ post.content|linebreaks }}</p>
    </div>
    {% if post.tags.all %}
      <p>
        <small>Tags:
          {% for t in post.tags.all %}
            <a href="{% url 'posts-by-tag' t.name %}">#{{ t.name }}</a>{% if not forloop.last %}, {% endif %}
          {% empty %}
            none
          {% endfor %}
        </small>
      </p>
    {% endif %}
  </article>
  <p>
    <a href="{% url 'post-list' %}">Back to Posts</a>
    {% if user == post.author %}
      • <a href="{% url 'post-edit' post.pk %}">Edit</a>
      • <a href="{% url 'post-delete' post.pk %}">Delete</a>
    {% endif %}
  </p>

  <hr>
  <section>
    <h3>Comments ({{ comments|length }})</h3>
    {% if comments %}
      <ul class="comment-list">
        {% for c in comments %}
          <li class="comment-item">
            <div>
              <strong>{{ c.author.username }}</strong>
              <small>• {{ c.created_at|date:'Y-m-d H:i' }}{% if c.updated_at and c.updated_at != c.created_at %} (edited){% endif %}</small>
            </div>
            <div>{{ c.content|linebreaks }}</div>
            {% if user == c.author %}
              <div class="comment-actions">
                <a href="{% url 'comment-edit' c.pk %}">Edit</a>
                • <a href="{% url 'comment-delete' c.pk %}">Delete</a>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No comments yet. Be the first to comment!</p>
    {% endif %}
  </section>

  <section>
    <h3>Leave a comment</h3>
    {% if user.is_authenticated %}
      <form action="{% url 'comment-create' post_pk=post.pk %}" method="post">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit">Post Comment</button>
      </form>
    {% else %}
      <p>
        <a href="{% url 'login' %}">Log in</a> to post a comment.
      </p>
    {% endif %}
  </section>
{% endblock %}
